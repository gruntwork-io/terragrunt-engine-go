syntax = "proto3";

package proto;
import "google/protobuf/any.proto";
option go_package = "./proto";

service Engine {
  // Initializes the engine with the provided request parameters.
  // Returns a stream of InitResponse messages.
  rpc Init(InitRequest) returns (stream InitResponse);

  // Runs a command with the provided request parameters.
  // Returns a stream of RunResponse messages.
  rpc Run(RunRequest) returns (stream RunResponse);

  // Shuts down the engine with the provided request parameters.
  // Returns a stream of ShutdownResponse messages.
  rpc Shutdown(ShutdownRequest) returns (stream ShutdownResponse);
}

message InitRequest {
  // Metadata information as a map of string keys to protobuf Any values.
  map<string, google.protobuf.Any> meta = 1;

  // Working directory path.
  string working_dir = 2;

  // Environment variables as a map of string keys to string values.
  map<string, string> env_vars = 3;
}

message InitResponse {
  oneof response {
    StdoutMessage stdout = 1;
    StderrMessage stderr = 2;
    ExitResultMessage exit_result = 3;
    LogMessage log = 4;
  }
}

message ShutdownRequest {
  // Metadata information as a map of string keys to protobuf Any values.
  map<string, google.protobuf.Any> meta = 1;

  // Working directory path.
  string working_dir = 2;

  // Environment variables as a map of string keys to string values.
  map<string, string> env_vars = 3;
}

message ShutdownResponse {
  oneof response {
    StdoutMessage stdout = 1;
    StderrMessage stderr = 2;
    ExitResultMessage exit_result = 3;
    LogMessage log = 4;
  }
}

message RunRequest {
  // Metadata information as a map of string keys to protobuf Any values.
  map<string, google.protobuf.Any> meta = 1;

  // Working directory path.
  string working_dir = 2;

  // Command to be executed.
  string command = 3;

  // Arguments for the command.
  repeated string args = 4;

  // Flag indicating if a pseudo-terminal should be allocated.
  bool allocate_pseudo_tty = 5;

  // Environment variables as a map of string keys to string values.
  map<string, string> env_vars = 6;
}

message RunResponse {
  oneof response {
    StdoutMessage stdout = 1;
    StderrMessage stderr = 2;
    ExitResultMessage exit_result = 3;
    LogMessage log = 4;
  }
}

// StdoutMessage contains standard output content.
message StdoutMessage {
  string content = 1;
}

// StderrMessage contains standard error output content.
message StderrMessage {
  string content = 1;
}

// ExitResultMessage contains the exit code from a process.
message ExitResultMessage {
  int32 code = 1;
}

// LogMessage contains a log message with a level and content.
// This is intended for informational/logging purposes, distinct from stdout/stderr.
message LogMessage {
  LogLevel level = 1;
  string content = 2;
}

enum LogLevel {
  LOG_LEVEL_UNSPECIFIED = 0;
  LOG_LEVEL_DEBUG = 1;
  LOG_LEVEL_INFO = 2;
  LOG_LEVEL_WARN = 3;
  LOG_LEVEL_ERROR = 4;
}
